<!--div class="widget">
  <h3>Basic Demo App</h3>
  <div class="content">

    <div class="app-box">
      <div class="logo"></div>
      <p id="apptext" class="app-text text-center">
      </p>
    </div>

  </div>
</div-->
<link rel="stylesheet" type="text/css" href="https://testcanvastesting.herokuapp.com/newview/app/style.css">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<div class="widget" id="hippo-widget">
	<h3>Rapid Video Creation & Sharing</h3>
  	<div class="content">
    	<div class="app-box">
		    <div class="fd-wiz" id="videoPanel">
				<div class="text-center"><img src="{{'img-1.png' | asset_url}}" /></div>
				<div class="error-box hide"><img src="{{'error-round.png' | asset_url}}" />&nbsp; <span id="error-box-text">An error occured. Contact support.</span></div>

				<div class="info-box hide"><img src="{{'info-round.png' | asset_url}}" />&nbsp; Success Message!</div>

				<div class="hiw text-center"><a id="hippo-how-it-works" class="">How Hippo Video works?</a></div>

				<div class="wiz-action-boxes text-center">
					<div class="video-ticket-link-div" style="display: none" id="hippo-ticket-click-message">
						<img src="{{'close.png' | asset_url}}" id="hippo-close-ticket-help" class="close-icon" />
						<span>A link is added to reply. It lets your customer create a video of the issue and send it as reply.</span>
						<input type="text" id="guest-copy-link" value="" readonly class="hippo-ticket-url" />
						<label class="ticket-copy-link hippo-copy-api-key" id="hippo-ticket-copy-link" data-copyurl="#guest-copy-link">Copy Link</label>
						<label class="ticket-copy-link hippo-copied-api-key" style="display:none">Copied</label>
					</div>
					
					<div id="deactivated-error" class="absolute lock-overlay" style="display:none"><img class="lock-image" src="{{'lock.png' | asset_url}}" /></div>
					<a class="record hide">
						<div class="wiz-box left-curve text-center">
							<div class="fda-image"><img src="{{'img-2.png' | asset_url}}" /></div>
							<label class="hwiz-label">share your story</label>
						</div>
					</a>
					<a class="howto" id="hippo-howto-box">
						<!--div class="wiz-box no-curve text-center"-->
						<div class="wiz-box left-curve text-center">
							<div class="fda-image"><img src="{{'img-3.png' | asset_url}}" /></div>
							<label class="hwiz-label">RECORD an EXPLAINER VIDEO</label>
						</div>
					</a>
					<div class="wiz-box right-curve text-center" id="hippo-testimonial-box">
						<div class="soon-text">Coming Soon</div>
						<div class="fda-image"><img src="{{'testimonial.png' | asset_url}}" /></div>
						<label class="hwiz-label">get customer testimonial</label>
					</div>	
					<div class="hiw text-center"><a href="https://www.hippowiz.com/how-it-works.html" target="_blank"></a></div>

					<button class="video-ticket-div hippo-copy-button" id="hippo-video-ticket-link" data-copyurl="#guest-copy-link">
						<img src="{{'video-ticket.png' | asset_url}}" class="video-ticket-icon" />
						<span>Ask customer to reply with video</span>
					</button>
					<img src="{{'help.png' | asset_url}}" class="ticket-help" id="hippo-ticket-help" />
				</div>
				<div id="view-recorded-link" class="hiw margin-top-18 text-center"><img src="{{'eye.png' | asset_url}}" class="eye-icon" />&nbsp;&nbsp;<a href="#" class='show-library'>View recorded videos</a></div>
				<div id="dont-show-again-link" style="display: none" class="hiw margin-top-18 text-center"><a>Don't show this again</a></div>
					
			</div>

			<!-- -->
			<div class="fd-wiz" id="libraryPanel">
				<div class="top-box">
					<a href="" class="go-back">
	      				<img src="{{'back-arrow.png' | asset_url}}" class="logo-img" />
	      				<span>Go Back</span><!-- <b id="videoCount" class="wiz-vdo-count"></b> -->
      				</a>
      				<a class="create-video-link">Create Video</a>
    			</div>

				<!-- <div class="tab-buttons-space text-center">
					<a class="active">My Videos</a>
					<a class="">All Videos</a>
				</div> -->

				<div class="tab-buttons-space text-center">
					<a class="tablinks active" data-myid="myvideos" id="defaultOpen">My Videos</a>
					<a class="tablinks" data-myid='allvideos'>All Videos</a>
					<div id="videoCount" class="wiz-vdo-count" title="Videos count">0</div>
				</div>

				<div id="loading" class="text-center"><img src="{{'loading.gif' | asset_url}}" width="24" height="24" class="loading-gif"></div>

				<div id="myvideos" class="tabcontent lib-view">
				  <div id="myvideos-emptylib" class="empty-video-list" style="display:none"><img src="{{'empty-hippo.png' | asset_url}}" /><label>You have no videos to display</label></div>
				</div>

				<div id="allvideos" class="tabcontent lib-view" style="display:none">
				  <div id="allvideos-emptylib" class="empty-video-list" style="display:none"><img src="{{'empty-hippo.png' | asset_url}}" /><label>You have no videos to display</label></div>
				</div>

			   <script id="template-list-item" type="text/template">
					<div id="{id}" class="urlLink list-view clearfix" data-url="{url}" data-title="{title}">
					  <a href="{url}" target="_blank">
						  <div class="video-thumb-nail">
						  	<img src="{{'black-overlay.png' | asset_url}}" class="absolute overlay-img" />
						  	<span class="absolute preview-text">Preview</span>
						    <img src="{thumb}" />
						  </div>
					  </a>
					  <div class="video-details">
					    <p>{title}</p>
					    <h6>Recorded on {created_at}</h6>
					    <label class="play-time">{duration}</label>
					  	<button class="copy-link-space hippo-copy-button {copy_id}-copy-key" data-copyurl="#url-{copy_id}-{id}"><img src="{{'copy-icon.png' | asset_url}}" class="copy-img" />Add to Reply</button>
					  	<input type="hidden" id="url-{copy_id}-{id}" class="hippo-copy-url" value="{url}" data-thumbimage="{thumb}" data-thumbtitle="{title}">
					  </div>
					</div>
			    </script>
			</div>
			<!--   -->
    	</div>
  	</div>
</div>

<script type="text/javascript">
	
	$('.show-library').on('click', {that: this}, this.fetchRecentVideos);
      $('.show-library').on('click', {that: this}, this.closeVideoPanel);
      $('#hippo-video-ticket-link').on('click', {that: this}, this.addUrlToReply);
      $('#dont-show-again-link').on('click', {that: this}, this.dontShowHandler);
      $('#hippo-ticket-help').on('click', {that: this}, this.showTicketHelp);
      $('#hippo-close-ticket-help').on('click', {that: this}, this.closeTicketHelp);
     // jQuery(this.$container).find('.create-video-link').on('click', {that: this}, this.colselibraryPanel);
      $('.go-back').on('click', {that: this}, this.closelibraryPanel);
      $('#hippo-ticket-copy-link').on('click', {that: this}, this.onCopyLink);
      
      authorize();

      function authorize() 
      {
      	 var self = this;

      	 self.domain="https://www.hippovideo.io/";
        var options = { body: "api_key=<%= iparam.wiz_api_key %>&email="+self.agentEmail};
        var url = domain+'/api/user/token.json';
        $.post(url, options)
          .done(function(data){
            var parsedResponse = JSON.parse(data.response);
            if(parsedResponse.status == false){
              console.log("Failed :: ",parsedResponse.fail_type);
              if(parsedResponse.fail_type == "deactivated" 
                      || parsedResponse.fail_type == "user_not_connected"){
                self.checkDontShow(function(result){
                  if(result){
                    document.getElementById("hippo-widget").style.display="none";
                  } else {
                    document.getElementById("dont-show-again-link").style.display='block';
                    document.getElementById("deactivated-error").style.display='block';
                    self.handleWidgetError("Contact your admin to enable Hippo Video.");
                  }
                });
              }else if(parsedResponse.fail_type == "invalid_license"){
                document.getElementById("deactivated-error").style.display='block';
                self.handleWidgetError("Please upgrade to continue using Hippo Video.");
              }
              else if(parsedResponse.fail_type == "invalid_api"){
                self.handleWidgetError("Please provide a valid API Key or contact Hippo Video support.");
              } else {
                self.handleWidgetError("There seems to be an error. Contact Hippo Video support.");
              }
            } else {

              ////////  
              self.authToken = "Y6dL8EfsLUg5uGaiyTCk";
              self.clickHandling(self.authToken);
              self.getGuestUrl(self.authToken);
            }
          })
          .fail(function(err){
            if(err){
              self.handleWidgetError("There seems to be an error. Contact Hippo Video support.");
            }
          });     
      }

      function clickHandling(authToken)
      {
      

	      var howItWorks = $('#hippo-how-it-works');
	      howItWorks.attr('href', this.domain+'/faq.html');
	      howItWorks.attr('target', '_blank');

	      var howtoLink = $('.howto');
	      howtoLink.attr('href', this.domain+'/video/home?authentication_token='+authToken+'&email='+this.agentEmail);
	      howtoLink.attr('target', '_blank');

	      // Create video link
	      var howtoLink = $('.create-video-link');
	      howtoLink.attr('href', this.domain+'/video/home?authentication_token='+authToken+'&email='+this.agentEmail);
	      howtoLink.attr('target', '_blank');

   }

   function getGuestUrl(authToken)
   {
      var self = this;
      var options = { body: "authentication_token="+authToken+"&email="+self.agentEmail+"&video_fetch_type=all"};
      var ticketId = domHelper.ticket.getTicketInfo()['helpdesk_ticket']['display_id'];
      var url = this.domain+'/api/user/guest_link.json';
      
      if(ticketId != undefined && ticketId != ''){
        var url = this.domain+'/api/user/guest_link/'+ticketId+'.json';
      }
      this.$request.post(url, options)
        .done(function(data){
          var guestUrl = JSON.parse(data.response).url;
          var guestCopyLink = $('#guest-copy-link');
          guestCopyLink.attr('value', guestUrl);
          // jQuery(self.$container).find('#hippo-ticket-copy-link').on('click', {that: self}, self.onCopyLink);
        })
        .fail(function(err){
          // nothing to do
          if(err){}
        });
   }



</script>>