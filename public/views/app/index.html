<!--div class="widget">
  <h3>Basic Demo App</h3>
  <div class="content">

    <div class="app-box">
      <div class="logo"></div>
      <p id="apptext" class="app-text text-center">
      </p>
    </div>

  </div>
</div-->
<link rel="stylesheet" type="text/css" href="https://testcanvastesting.herokuapp.com/views/app/style.css">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<div class="widget" id="hippo-widget">
	<h3>Rapid Video Creation & Sharing</h3>
  	<div class="content">
    	<div class="app-box">
		    <div class="fd-wiz" id="videoPanel">
				<div class="text-center"><img src="https://testcanvastesting.herokuapp.com/views/assets/img-1.png" /></div>
				<div class="error-box hide"><img src="https://testcanvastesting.herokuapp.com/views/assets/error-round.png" />&nbsp; <span id="error-box-text">An error occured. Contact support.</span></div>

				<div class="info-box hide"><img src="https://testcanvastesting.herokuapp.com/views/assets/info-round.png" />&nbsp; Success Message!</div>

				<div class="hiw text-center"><a id="hippo-how-it-works" class="">How Hippo Video works?</a></div>

				<div class="wiz-action-boxes text-center">
					<div class="video-ticket-link-div" style="display: none" id="hippo-ticket-click-message">
						<img src="https://testcanvastesting.herokuapp.com/views/assets/close.png" id="hippo-close-ticket-help" class="close-icon" />
						<span>A link is added to reply. It lets your customer create a video of the issue and send it as reply.</span>
						<input type="text" id="guest-copy-link" value="" readonly class="hippo-ticket-url" />
						<label class="ticket-copy-link hippo-copy-api-key" id="hippo-ticket-copy-link" data-copyurl="#guest-copy-link">Copy Link</label>
						<label class="ticket-copy-link hippo-copied-api-key" style="display:none">Copied</label>
					</div>
					
					<div id="deactivated-error" class="absolute lock-overlay" style="display:none"><img class="lock-image" src="https://testcanvastesting.herokuapp.com/views/assets/lock.png" /></div>
					<a class="record hide">
						<div class="wiz-box left-curve text-center">
							<div class="fda-image"><img src="https://testcanvastesting.herokuapp.com/views/assets/img-2.png" /></div>
							<label class="hwiz-label">share your story</label>
						</div>
					</a>
					<a class="howto" id="hippo-howto-box">
						<!--div class="wiz-box no-curve text-center"-->
						<div class="wiz-box left-curve text-center">
							<div class="fda-image"><img src="https://testcanvastesting.herokuapp.com/views/assets/img-3.png" /></div>
							<label class="hwiz-label">RECORD an EXPLAINER VIDEO</label>
						</div>
					</a>
					<div class="wiz-box right-curve text-center" id="hippo-testimonial-box" style="display: none">
						<div class="soon-text">Coming Soon</div>
						<div class="fda-image"><img src="https://testcanvastesting.herokuapp.com/views/assets/testimonial.png" /></div>
						<label class="hwiz-label">get customer testimonial</label>
					</div>	
					<div class="hiw text-center"><a href="https://www.hippowiz.com/how-it-works.html" target="_blank"></a></div>

					<button class="video-ticket-div hippo-copy-button" id="hippo-video-ticket-link" data-copyurl="#guest-copy-link">
						<img src="https://testcanvastesting.herokuapp.com/views/assets/video-ticket.png" class="video-ticket-icon" />
						<span>Ask customer to reply with video</span>
					</button>
					<img src="https://testcanvastesting.herokuapp.com/views/assets/help.png" class="ticket-help" id="hippo-ticket-help" />
				</div>
				<div id="view-recorded-link" class="hiw margin-top-18 text-center"><img src="https://testcanvastesting.herokuapp.com/views/assets/eye.png" class="eye-icon" />&nbsp;&nbsp;<a href="#" class='show-library'>View recorded videos</a></div>
				<div id="dont-show-again-link" style="display: none" class="hiw margin-top-18 text-center"><a>Don't show this again</a></div>
					
			</div>

			<!-- -->
			<div class="fd-wiz" id="libraryPanel">
				<div class="top-box">
					<a href="" class="go-back">
	      				<img src="https://testcanvastesting.herokuapp.com/views/assets/back-arrow.png" class="logo-img" />
	      				<span>Go Back</span><!-- <b id="videoCount" class="wiz-vdo-count"></b> -->
      				</a>
      				<a class="create-video-link">Create Video</a>
    			</div>

				<!-- <div class="tab-buttons-space text-center">
					<a class="active">My Videos</a>
					<a class="">All Videos</a>
				</div> -->

				<div class="tab-buttons-space text-center">
					<a class="tablinks active" data-myid="myvideos" id="defaultOpen">My Videos</a>
					<a class="tablinks" data-myid='allvideos'>All Videos</a>
					<div id="videoCount" class="wiz-vdo-count" title="Videos count">0</div>
				</div>

				<div id="loading" class="text-center"><img src="https://testcanvastesting.herokuapp.com/views/assets/loading.gif" width="24" height="24" class="loading-gif"></div>

				<div id="myvideos" class="tabcontent lib-view">
				  <div id="myvideos-emptylib" class="empty-video-list" style="display:none"><img src="https://testcanvastesting.herokuapp.com/views/assets/empty-hippo.png" /><label>You have no videos to display</label></div>
				</div>

				<div id="allvideos" class="tabcontent lib-view" style="display:none">
				  <div id="allvideos-emptylib" class="empty-video-list" style="display:none"><img src="https://testcanvastesting.herokuapp.com/views/assets/empty-hippo.png" /><label>You have no videos to display</label></div>
				</div>

			   <script id="template-list-item" type="text/template">
					<div id="{id}" class="urlLink list-view clearfix" data-url="{url}" data-title="{title}">
					  <a href="{url}" target="_blank">
						  <div class="video-thumb-nail">
						  	<img src="https://testcanvastesting.herokuapp.com/views/assets/black-overlay.png" class="absolute overlay-img" />
						  	<span class="absolute preview-text">Preview</span>
						    <img src="{thumb}" />
						  </div>
					  </a>
					  <div class="video-details">
					    <p>{title}</p>
					    <h6>Recorded on {created_at}</h6>
					    <label class="play-time">{duration}</label>
					  	<button class="copy-link-space hippo-copy-button {copy_id}-copy-key" data-copyurl="#url-{copy_id}-{id}"><img src="https://testcanvastesting.herokuapp.com/views/assets/copy-icon.png" class="copy-img" />Add to Reply</button>
					  	<input type="hidden" id="url-{copy_id}-{id}" class="hippo-copy-url" value="{url}" data-thumbimage="{thumb}" data-thumbtitle="{title}">
					  </div>
					</div>
			    </script>
			</div>
			<!--   -->
    	</div>
  	</div>
</div>

<script type="text/javascript">
	var email="prasanna@lyceuminc.com"
	$('.show-library').on('click', fetchVideos);
      $('.show-library').on('click', closeVideoPanel);
      $('#hippo-video-ticket-link').on('click',copyUrl);
      //$('#dont-show-again-link').on('click', dontShowHandler);
      //$('#hippo-ticket-help').on('click', showTicketHelp);
     // $('#hippo-close-ticket-help').on('click', closeTicketHelp);
     // jQuery(this.$container).find('.create-video-link').on('click', {that: this}, this.colselibraryPanel);
      $('.go-back').on('click', closelibraryPanel);
      //$('#hippo-ticket-copy-link').on('click', onCopyLink);
      $('.error-box').hide();
      $('.info-box').hide();
      
      authorize();

      function authorize() 
      {
      	 var self = this;

      	 self.domain="https://www.hippovideo.io/";
        var options = { body: "api_key=<%= iparam.wiz_api_key %>&email="+self.agentEmail};
        var url = domain+'/api/user/token.json';
        $.post(url, options)
          .done(function(data){
            var parsedResponse = JSON.parse(data.response);
            if(parsedResponse.status == false)
            {
            } 
            else 
            {
              self.authToken = "Y6dL8EfsLUg5uGaiyTCk";
              self.clickHandling(self.authToken);
              self.getGuestUrl(self.authToken);
            }
          })
          .fail(function(err){
            if(err){

              self.authToken = "Y6dL8EfsLUg5uGaiyTCk";
              self.clickHandling(self.authToken);
              self.getGuestUrl(self.authToken);
              //self.handleWidgetError("There seems to be an error. Contact Hippo Video support.");
            }
          });     
      }

      function clickHandling(authToken)
      {
      

	      var howItWorks = $('#hippo-how-it-works');
	      howItWorks.attr('href', this.domain+'/faq.html');
	      howItWorks.attr('target', '_blank');

	      var howtoLink = $('.howto');
	      howtoLink.attr('href', this.domain+'/video/home?authentication_token='+authToken+'&email='+this.agentEmail);
	      howtoLink.attr('target', '_blank');

	      // Create video link
	      var howtoLink = $('.create-video-link');
	      howtoLink.attr('href', this.domain+'/video/home?authentication_token='+authToken+'&email='+this.agentEmail);
	      howtoLink.attr('target', '_blank');

   }

   function copyUrl()
   {

   }

   function closeVideoPanel(event)
   {
   	$('#videoPanel').hide();
   	$('#libraryPanel').show();
      
    }

   function getGuestUrl(authToken)
   {
     
   }

   function handleWidgetError(errorText)
   {
      document.getElementById("view-recorded-link").style.display='none';
      document.getElementById("error-box-text").innerHTML = errorText;
      
      
    }

    function closelibraryPanel(event)
    {

      document.getElementById("libraryPanel").style.display = 'none';
      document.getElementById("videoPanel").show();
    }

function fetchVideos(fetchAllVideos, success, error) 
{
  var payload;
  var url;
  //console.log("AUHHHHH TOKEN :: ",this.authToken);
  if(fetchAllVideos){
      payload = "authentication_token="+authToken+"&email="+email+"&video_fetch_type=all";
      //url = hippoDomain+'/api/video/recent_videos.json'; // Recent videos as of now fetches all videos need to make change in rails
      url='https://testcanvastesting.herokuapp.com/views_bkp/video.json';
  } else {
      payload = "authentication_token="+authToken+"&email="+email;
      //url = 'hippoDomain+'/api/video/recent_videos.json'';
      url='https://testcanvastesting.herokuapp.com/views_bkp/video.json';
  }
  $.getJSON(url, function(json) {
      populateVideoLibrary("myvideo", json);
  });
   
  
  $('.hv-fd-loader').show();
}

// Populates the videos in the curresponding block
function populateVideoLibrary(type, library){
  var videoNode = constructVideoNode(type, library);
  //if(type == "myvideo")
  {
    $('.hv-fd-myvideo-container').empty().append($(videoNode));
  } 
  //else 
  {
    $('.hv-fd-allvideo-container').empty().append($(videoNode));
  }
  $('.hv-fd-add-reply-link').on('click', addLinkToReply);
  
}

function constructVideoNode(type, jsonObj){
    var videosJson = (jsonObj);
    var library = videosJson.libraries;
    var categoryMapping = videosJson.category_mapping;
    var categories = videosJson.categories;
    var templateHtml = $('.hv-fd-library-template').html();
    var categoryTemplateHtml = $('.hv-fd-category-template').html();
    var listHtml = "";
    var categoryHtml = "";
    var categoryAttr = "";
    var categoryMapJson = {};
    var categoryClass;
    currentVideoCount = library.length;
    if(type == "allvideos"){
      allVideoCount = currentVideoCount;
    }else {
      myVideoCount = currentVideoCount;
    }
    console.log("LIBRARY >>>>>> "+type+" :: "+currentVideoCount);
    $.each(categoryMapping, function(i, categoryMap){
      if(categoryMapJson[categoryMap.authoring_asset_id] == undefined || categoryMapJson[categoryMap.authoring_asset_id] == "undefined"){
        categoryMapJson[categoryMap.authoring_asset_id] = [];
        categoryMapJson[categoryMap.authoring_asset_id].push(categoryMap.video_categories_id);
        categoryMapJson[categoryMap.authoring_asset_id].push(0);
      } else {
        categoryMapJson[categoryMap.authoring_asset_id].push(categoryMap.video_categories_id);
      }
    });
    var count=0;
    var lib='';
    for (var i = 0; i < library.length; i++) 
    {
      lib=library[i];
      categoryClass = "";
      if (lib.id in categoryMapJson)
      {
        categoryClass += "hv-fd-video-category-"+categoryMapJson[lib.id]+" ";
      }
      if(categoryClass == ""){
        categoryClass = "hv-fd-video-category-0";
      }
      listHtml += templateHtml.replace(/{{id}}/g, lib.id)
            .replace(/{{title}}/g, lib.title)
            .replace(/{{url}}/g, lib.url)
            .replace(/{{created_at}}/g, lib.created_at)
            .replace(/{{num_viewed}}/g, lib.num_viewed)
            .replace(/{{copy_id}}/g, jsonObj.type)
            .replace(/{{thumb}}/g, lib.thumb)
            .replace(/{{duration}}/g, lib.duration)
            .replace(/{{thumb_url}}/g, lib.thumbnail_url)
            .replace(/{{category_class}}/g, categoryClass);

    }

    // $.each(library, function(i, lib) {
    //   categoryClass = "";
    //   $.each(categoryMapJson[lib.id], function(j, catId){
    //     categoryClass += "hv-fd-video-category-"+catId+" ";
    //   });
    //   if(categoryClass == ""){
    //     categoryClass = "hv-fd-video-category-0";
    //   }
    //   if(!lib.is_error && lib.title != null){
    //     listHtml += templateHtml.replace(/{{id}}/g, lib.id)
    //                 .replace(/{{title}}/g, lib.title)
    //                 .replace(/{{url}}/g, lib.url)
    //                 .replace(/{{created_at}}/g, lib.created_at)
    //                 .replace(/{{num_viewed}}/g, lib.num_viewed)
    //                 .replace(/{{copy_id}}/g, jsonObj.type)
    //                 .replace(/{{thumb}}/g, lib.thumb)
    //                 .replace(/{{duration}}/g, lib.duration)
    //                 .replace(/{{thumb_url}}/g, lib.thumbnail_url)
    //                 .replace(/{{category_class}}/g, categoryClass);
    //   }
    //   count++;
    //   console.log(count);
    //   if(count>9)
    //       return listHtml;
    //     $('.hv-fd-category-dropdown').empty().append($(categoryHtml));
    // $('.hv-fd-category-dropdown').prepend($('<option value="0" selected>All Categories</option>'));
    // });
    
    $('.hv-fd-category-dropdown').empty().append($(categoryHtml));
    $('.hv-fd-category-dropdown').prepend($('<option value="0" selected>All Categories</option>'));
    return listHtml;
  }


</script>>
