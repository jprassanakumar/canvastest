<!--div class="widget">
  <h3>Basic Demo App</h3>
  <div class="content">

    <div class="app-box">
      <div class="logo"></div>
      <p id="apptext" class="app-text text-center">
      </p>
    </div>

  </div>
</div-->
<link rel="stylesheet" type="text/css" href="https://testcanvastesting.herokuapp.com/views/app/style.css">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://ajax.deskapi.com/libs/desk/canvas/1.0.0/desk-canvas-all.js"></script>
<div class="widget" id="hippo-widget">
	<h3>Rapid Video Creation & Sharing</h3>
  	<div class="content">
    	<div class="app-box">
		    <div class="fd-wiz" id="videoPanel">
				<div class="text-center"><img src="https://testcanvastesting.herokuapp.com/views/assets/img-1.png" /></div>
				<div class="error-box hide"><img src="https://testcanvastesting.herokuapp.com/views/assets/error-round.png" />&nbsp; <span id="error-box-text">An error occured. Contact support.</span></div>

				<div class="info-box hide"><img src="https://testcanvastesting.herokuapp.com/views/assets/info-round.png" />&nbsp; Success Message!</div>

				<div class="hiw text-center"><a id="hippo-how-it-works" class="">How Hippo Video works?</a></div>

				<div class="wiz-action-boxes text-center">
					<div class="video-ticket-link-div" style="display: none" id="hippo-ticket-click-message">
						<img src="https://testcanvastesting.herokuapp.com/views/assets/close.png" id="hippo-close-ticket-help" class="close-icon" />
						<span>A link is added to reply. It lets your customer create a video of the issue and send it as reply.</span>
						<input type="text" id="guest-copy-link" value="" readonly class="hippo-ticket-url" />
						<label class="ticket-copy-link hippo-copy-api-key" id="hippo-ticket-copy-link" data-copyurl="#guest-copy-link">Copy Link</label>
						<label class="ticket-copy-link hippo-copied-api-key" style="display:none">Copied</label>
					</div>
					
					<div id="deactivated-error" class="absolute lock-overlay" style="display:none"><img class="lock-image" src="https://testcanvastesting.herokuapp.com/views/assets/lock.png" /></div>
					<a class="record hide">
						<div class="wiz-box left-curve text-center">
							<div class="fda-image"><img src="https://testcanvastesting.herokuapp.com/views/assets/img-2.png" /></div>
							<label class="hwiz-label">RECORD EXPLAINER VIDEO</label>
						</div>
					</a>
					<a class="howto" id="hippo-howto-box">
						<!--div class="wiz-box no-curve text-center"-->
						<div class="wiz-box left-curve text-center">
							<div class="fda-image"><img src="https://testcanvastesting.herokuapp.com/views/assets/img-3.png" /></div>
							<label class="hwiz-label">REPLY WITH VIDEO TICKET</label>
						</div>
					</a>
					<div class="wiz-box right-curve text-center" id="hippo-testimonial-box" style="display: none">
						<div class="soon-text">Coming Soon</div>
						<div class="fda-image"><img src="https://testcanvastesting.herokuapp.com/views/assets/testimonial.png" /></div>
						<label class="hwiz-label">get customer testimonial</label>
					</div>	
					<div class="hiw text-center"><a href="https://www.hippowiz.com/how-it-works.html" target="_blank"></a></div>

					<button class="video-ticket-div hippo-copy-button" id="hippo-video-ticket-link" data-copyurl="#guest-copy-link">
						<img src="https://testcanvastesting.herokuapp.com/views/assets/video-ticket.png" class="video-ticket-icon" />
						<span>Ask customer to reply with video</span>
					</button>
					<img src="https://testcanvastesting.herokuapp.com/views/assets/help.png" class="ticket-help" id="hippo-ticket-help" />
				</div>
				<div id="view-recorded-link" class="hiw margin-top-18 text-center"><img src="https://testcanvastesting.herokuapp.com/views/assets/eye.png" class="eye-icon" />&nbsp;&nbsp;<a href="#" class='show-library'>View recorded videos</a></div>
				<div id="dont-show-again-link" style="display: none" class="hiw margin-top-18 text-center"><a>Don't show this again</a></div>
					
			</div>

			<!-- -->
			<div class="fd-wiz" id="libraryPanel">
				<div class="top-box">
					<a href="" class="go-back">
	      				<img src="https://testcanvastesting.herokuapp.com/views/assets/back-arrow.png" class="logo-img" />
	      				<span>Go Back</span><!-- <b id="videoCount" class="wiz-vdo-count"></b> -->
      				</a>
      				<a class="create-video-link">Create Video</a>
    			</div>

				<!-- <div class="tab-buttons-space text-center">
					<a class="active">My Videos</a>
					<a class="">All Videos</a>
				</div> -->

				<div class="tab-buttons-space text-center">
					<a class="tablinks active" data-myid="myvideos" id="defaultOpen">My Videos</a>
					<a class="tablinks" data-myid='allvideos'>All Videos</a>
					<div id="videoCount" class="wiz-vdo-count" title="Videos count">0</div>
				</div>

				<div id="loading" class="text-center"><img src="https://testcanvastesting.herokuapp.com/views/assets/loading.gif" width="24" height="24" class="loading-gif"></div>

				<div id="myvideos" class="tabcontent lib-view">
				  <div id="myvideos-emptylib" class="empty-video-list" style="display:none"><img src="https://testcanvastesting.herokuapp.com/views/assets/empty-hippo.png" /><label>You have no videos to display</label></div>
				</div>

				<div id="allvideos" class="tabcontent lib-view" style="display:none">
				  <div id="allvideos-emptylib" class="empty-video-list" style="display:none"><img src="https://testcanvastesting.herokuapp.com/views/assets/empty-hippo.png" /><label>You have no videos to display</label></div>
				</div>
				</script>
			    <!-- Template for video list -->
			    <script class="hv-fd-library-template" type="text/template">
			      <div class="hv-fd-video-list-row {{category_class}}">
			        <div class="video-thumb-div"><img src="{{thumb}}" /></div>
			        <div class="rhs">
			          <label class="hv-fd-video-name">{{title}}</label>
			          <label class="recorede-date">Recorded on {{created_at}}</label>
			          <label class="video-deration">{{duration}}</label>
			          <label class="hv-fd-add-reply-block"><a class="hv-fd-add-reply-link" data-ref="hv-fd-copy-ref-{{id}}">Copy to clipboard</a></label>
			          <input type="hidden" class="hv-fd-copy-ref-{{id}} hv-fd-video-copy-url" value="{{url}}" data-thumburl="{{thumb_url}}" data-thumbimage="{{thumb}}" data-thumbtitle="{{title}}">
			        </div>
			      </div>
			    </script>
			    <!-- Template for categories -->
			    <script class="hv-fd-category-template" type="text/template">
			      <option value="{{category_id}}" {{attribute}}>{{category_name}}</option>
			    </script>

			</div>
			<!--   -->
    	</div>
  	</div>
</div>

<script type="text/javascript">
	var email="prasanna@lyceuminc.com";
	var agentEmail="prasanna@lyceuminc.com";
	var ticketId='';
	var authToken='';
	var myVideoCount=0;
	var allVideoCount=0;
	var context='';
	var productUsers=[];
	var productDomain='';
	var hippoDomain="https://www.hippovideo.io/";
	var ticketRecordUrl='#';
	    Desk.canvas(function() {
     
      Desk.canvas.client.refreshSignedRequest(function(data) {
        // Grab the response and save it to a variable.
        var signedRequest = data.payload.response;
        console.log(signedRequest);
        // Base64-decode the second part of the signed request.
        var decodedRequest = Desk.canvas.decode(signedRequest.split('.')[1]);
        // The result is a JSON representation of the context. Let's parse that into a Javascript object.
        var contextObj = JSON.parse(decodedRequest);
        context=signedRequest;

        Desk.canvas.client.signedrequest(contextObj);
      
      var url      = contextObj.client.targetOrigin+'/api/v2/users/27732944/groups';//contextObj.context.environment.case.url + '/replies/draft'

      var userUrl      = contextObj.context.links.userUrl;//contextObj.context.environment.case.url + '/replies/draft'
      ticketId=contextObj.context.environment.case.id;
      domain=contextObj.context.organization.name;
            console.log(userUrl);
              Desk.canvas.client.ajax(userUrl, {
                client: contextObj.client,
                method: 'GET',
                success: function(rsp) {
                  console.log(rsp);
                  var groupUrl=rsp.payload._links.groups.href;
                  console.log(groupUrl);
                  Desk.canvas.client.ajax(groupUrl, {
                    client: contextObj.client,
                    method: 'GET',
                    success: function(rsp) {
                      console.log(rsp);
                      var userUrl=rsp.payload._embedded.entries[0]._links.users.href;
                      console.log(userUrl);
                      Desk.canvas.client.ajax(userUrl, {
                        client: contextObj.client,
                        method: 'GET',
                        success: function(rsp) {
                          console.log(rsp);
                          var users=rsp.payload._embedded.entries;
                          for (var i = 0; i < users.length; i++) 
                          {
                            console.log(users[i].email);
                            var user = {email: users[i].email,verified: users[i].email_verified,name: users[i].name,level: users[i].level};
                            productUsers.push(user);

                            //parent.document.body.style.backgroundColor = "red";
                          }
                          authorize();
                          getTicketVideoURL();
                        }
                      });

                    }
                  });    
                }
             });

		});

    });      


	$('.show-library').on('click', fetchVideos);
      $('.show-library').on('click', closeVideoPanel);
      $('#hippo-video-ticket-link').on('click',copyUrl);
      //$('#dont-show-again-link').on('click', dontShowHandler);
      //$('#hippo-ticket-help').on('click', showTicketHelp);
     // $('#hippo-close-ticket-help').on('click', closeTicketHelp);
     // jQuery(this.$container).find('.create-video-link').on('click', {that: this}, this.colselibraryPanel);
      $('.go-back').on('click', closelibraryPanel);
      //$('#hippo-ticket-copy-link').on('click', onCopyLink);
      $('.error-box').hide();
      $('.info-box').hide();
      
      

      function authorize() 
      {
        var options = { body: context,email: agentEmail,domain: productDomain,sync_agents: productUsers};
        url = this.hippoDomain+"/api/sf_desk_signup.json";
        $.post(url, options)
          .done(function(data){
            var parsedResponse = JSON.parse(data.response);
            if(parsedResponse.status == false)
            {
            } 
            else 
            {
              self.authToken = "";
              self.clickHandling(self.authToken);
              self.getGuestUrl(self.authToken);
            }
          })
          .fail(function(err){
            if(err){

              self.authToken = "";
              self.clickHandling(self.authToken);
              self.getGuestUrl(self.authToken);
              //self.handleWidgetError("There seems to be an error. Contact Hippo Video support.");
            }
          });     
      }

      function clickHandling(authToken)
      {
      

	      var howItWorks = $('#hippo-how-it-works');
	      howItWorks.attr('href', this.domain+'/faq.html');
	      howItWorks.attr('target', '_blank');

	      var howtoLink = $('.howto');
	      howtoLink.attr('href', this.domain+'/video/home?authentication_token='+authToken+'&email='+agentEmail);
	      howtoLink.attr('target', '_blank');

	      // Create video link
	      var howtoLink = $('.create-video-link');
	      howtoLink.attr('href', this.domain+'/video/home?authentication_token='+authToken+'&email='+agentEmail);
	      howtoLink.attr('target', '_blank');

	      var explainerBtn = $('.record');
		  explainerBtn.attr('href', this.hippoDomain+'/video/home?authentication_token='+this.authToken+'&email='+this.email);
		  explainerBtn.attr('target', '_blank');

	      $('#hippo-howto-box').on('click', insertTicketVideoLink);
		  $('#hippo-video-ticket-link').on('click', insertTicketVideoLink);

   	  }

   	  function getTicketVideoURL()
   	  {
          getUrlToRecord(ticketId);
          getUrlToRecord(undefined);
	  }

	function getUrlToRecord(ticketId)
	{
	    var options = { body: "authentication_token="+authToken+"&email="+email+"&video_fetch_type=all"};
	    var url = hippoDomain+'/api/user/guest_link.json';

	    if(ticketId != undefined && ticketId != ''){
	        var url = hippoDomain+'/api/user/guest_link/'+ticketId+'.json';
	    }

    	$.post(url, options).then (
        function(data) {
            var response = JSON.parse(data.response);
            //console.log(response);
            if(ticketId != undefined)
            {
                ticketRecordUrl = response.url;
            }
            else
            {
                guestRecordUrl = response.url;
            }
            //console.log(this.ticketRecordUrl);
        },
        function(error) {
            //console.log('Error in getting the url to record for ticket/guest');
            console.log(error);
        }
    	);
	}


   function insertTicketVideoLink(event)
   {
	    var self = event.data.that;
	    var msg = event.data.msg;
	    console.log('helloooooooo :: '+ticketRecordUrl);
	}
   function copyUrl(id)
   {
   	  var $temp = $("#"+id);
	  $("body").append($temp);
	  $temp.val($(element).text()).select();
	  document.execCommand("copy");
	  $temp.remove();
   }

   function closeVideoPanel(event)
   {
   	$('#videoPanel').hide();
   	$('#libraryPanel').show();
      
    }

   function getGuestUrl()
   {
      var self = this;
      var options = { body: "authentication_token="+authToken+"&email="+agentEmail+"&video_fetch_type=all"};
      
      var url = this.domain+'/api/user/guest_link.json';
      
      if(ticketId != undefined && ticketId != ''){
        var url = this.domain+'/api/user/guest_link/'+ticketId+'.json';
      }

      $.post(url, options)
          .done(function(data){
            var guestUrl = JSON.parse(data.response).url;
          var guestCopyLink = $('#guest-copy-link');
          guestCopyLink.attr('value', guestUrl);
          })
          .fail(function(err){
            if(err){
			var guestCopyLink = $('#guest-copy-link');
			guestCopyLink.attr('value', '');
            }
          });

   }

   function handleWidgetError(errorText)
   {
      document.getElementById("view-recorded-link").style.display='none';
      document.getElementById("error-box-text").innerHTML = errorText;
      
      
    }

    function closelibraryPanel(event)
    {
   		$('#libraryPanel').hide();
   		$('#videoPanel').show();
    }

	function fetchVideos(type,fetchAllVideos, success, error) 
	{
	  var payload;
	  var url;
	  //console.log("AUHHHHH TOKEN :: ",this.authToken);
	  if(fetchAllVideos){
	      payload = "authentication_token="+authToken+"&email="+email+"&video_fetch_type=all";
	      //url = hippoDomain+'/api/video/recent_videos.json'; // Recent videos as of now fetches all videos need to make change in rails
	      url='https://testcanvastesting.herokuapp.com/views_bkp/video.json';
	  } else {
	      payload = "authentication_token="+authToken+"&email="+email;
	      //url = 'hippoDomain+'/api/video/recent_videos.json'';
	      url='https://testcanvastesting.herokuapp.com/views_bkp/video.json';
	  }
	  $.getJSON(url, function(json) {
	      populateVideoLibrary(type, json);
	  });
	   
	  
	  $('.hv-fd-loader').show();
	  $('.tablinks').on('click',  self.toggleTab);


	}


  function toggleTab(evt) 
  {
      evt.preventDefault();
      evt.stopPropagation();
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tablinks");
      if(evt.target.dataset.myid == "allvideos"){
        fetchVideos(evt.target.dataset.myid);
      }
      updateCount(evt.target.dataset.myid);
      for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(evt.target.dataset.myid).style.display = "block";
      evt.currentTarget.className += " active";
   }

	function updateCount(tabName)
	{
      if(allVideoCount){
        if(tabName == "allvideos"){
          document.getElementById("videoCount").innerHTML = allVideoCount;
        }else{
          document.getElementById("videoCount").innerHTML = myVideoCount;
        }
      } else {
        document.getElementById("videoCount").innerHTML = 0;
      }
    }
// Populates the videos in the curresponding block
function populateVideoLibrary(type, library)
{
  var videoNode = constructVideoNode(type, library);
  if(type == "myvideo")
  {
    $('#allvideos').empty().append($(videoNode));
  } 
  else 
  {
    $('#myvideos').empty().append($(videoNode));
  }
  $('.hv-fd-add-reply-link').on('click', copyUrl);
  
}

function constructVideoNode(type, jsonObj){
    var videosJson = (jsonObj);
    var library = videosJson.libraries;
    var categoryMapping = videosJson.category_mapping;
    var categories = videosJson.categories;
    var templateHtml = $('.hv-fd-library-template').html();
    var categoryTemplateHtml = $('.hv-fd-category-template').html();
    var listHtml = "";
    var categoryHtml = "";
    var categoryAttr = "";
    var categoryMapJson = {};
    var categoryClass;
    currentVideoCount = library.length;
    if(type == "allvideos"){
      allVideoCount = currentVideoCount;
    }else {
      myVideoCount = currentVideoCount;
    }
    console.log("LIBRARY >>>>>> "+type+" :: "+currentVideoCount);
    $.each(categoryMapping, function(i, categoryMap){
      if(categoryMapJson[categoryMap.authoring_asset_id] == undefined || categoryMapJson[categoryMap.authoring_asset_id] == "undefined"){
        categoryMapJson[categoryMap.authoring_asset_id] = [];
        categoryMapJson[categoryMap.authoring_asset_id].push(categoryMap.video_categories_id);
        categoryMapJson[categoryMap.authoring_asset_id].push(0);
      } else {
        categoryMapJson[categoryMap.authoring_asset_id].push(categoryMap.video_categories_id);
      }
    });
    var count=0;
    var lib='';
    for (var i = 0; i < library.length; i++) 
    {
      lib=library[i];
      categoryClass = "";
      if (lib.id in categoryMapJson)
      {
        categoryClass += "hv-fd-video-category-"+categoryMapJson[lib.id]+" ";
      }
      if(categoryClass == ""){
        categoryClass = "hv-fd-video-category-0";
      }
      listHtml += templateHtml.replace(/{{id}}/g, lib.id)
            .replace(/{{title}}/g, lib.title)
            .replace(/{{url}}/g, lib.url)
            .replace(/{{created_at}}/g, lib.created_at)
            .replace(/{{num_viewed}}/g, lib.num_viewed)
            .replace(/{{copy_id}}/g, jsonObj.type)
            .replace(/{{thumb}}/g, lib.thumb)
            .replace(/{{duration}}/g, lib.duration)
            .replace(/{{thumb_url}}/g, lib.thumbnail_url)
            .replace(/{{category_class}}/g, categoryClass);

    }
    
    $('.hv-fd-category-dropdown').empty().append($(categoryHtml));
    $('.hv-fd-category-dropdown').prepend($('<option value="0" selected>All Categories</option>'));
    return listHtml;
  }


</script>>
