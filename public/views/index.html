<html>
<head>




  <title>
    Desk Canvas Test
  </title>
  <style media="screen" type="text/css">
  #context {
    background-color: oldlace;
  }
  </style>
</head>
<body>
  <!-- Include the Desk Canvas library, hosted on a CDN for your convenience -->
  <script src="https://ajax.deskapi.com/libs/desk/canvas/1.0.0/desk-canvas-all.js"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

  <script>

    var authToken=null;


    Desk.canvas(function() {

          $.ajax({
      method: 'post',
      url: "https://www.hippovideo.io/scitylana/1",
      success: function(resultData) { 
        console.log(resultData);
        alert("Save Complete"); 
      }
    });
     
      Desk.canvas.client.refreshSignedRequest(function(data) {
        // Grab the response and save it to a variable.
        var signedRequest = data.payload.response;
        // Base64-decode the second part of the signed request.
        var decodedRequest = Desk.canvas.decode(signedRequest.split('.')[1]);
        // The result is a JSON representation of the context. Let's parse that into a Javascript object.
        var contextObj = JSON.parse(decodedRequest);
        // Let's show what we actually get back.
	console.log(signedRequest);
        var contextElem = Desk.canvas.byId('context');
        var greetingElem = Desk.canvas.byId('greeting');
        greetingElem.innerHTML = 'Hi ' + contextObj.context.user.fullName + '!';
        // Using JSON.stringify here because this will look much nicer than just showing `decodedRequest`.
        contextElem.innerHTML = JSON.stringify(contextObj, undefined, 2);
        // We can also store this so we can reference it later without having to use a global variable.
        Desk.canvas.client.signedrequest(contextObj);
      
      var url      = contextObj.client.targetOrigin+'/api/v2/users/27732944/groups';//contextObj.context.environment.case.url + '/replies/draft'

      var userUrl      = contextObj.context.links.userUrl;//contextObj.context.environment.case.url + '/replies/draft'


            console.log(userUrl);
              Desk.canvas.client.ajax(userUrl, {
                client: contextObj.client,
                method: 'GET',
                success: function(rsp) {
                  console.log(rsp);
                  var groupUrl=rsp.payload._links.groups.href;
                  console.log(groupUrl);
                  Desk.canvas.client.ajax(groupUrl, {
                    client: contextObj.client,
                    method: 'GET',
                    success: function(rsp) {
                      console.log(rsp);
                      var userUrl=rsp.payload._embedded.entries[0]._links.users.href;
                      console.log(userUrl);
                      Desk.canvas.client.ajax(userUrl, {
                        client: contextObj.client,
                        method: 'GET',
                        success: function(rsp) {
                          console.log(rsp);
                          var users=rsp.payload._embedded.entries;
                          for (var i = 0; i < users.length; i++) 
                          {
                            console.log(users[i].email)

                            if(client._metadata.settings.wiz_api_key == "nil")
                            {
                              url = domain+'/api/zendesk_signup.json';
                              payload = {access_token: zdToken, domain: subDomain+".zendesk.com", email: agentEmail, app_id: client._metadata.installationId, sync_agents: true}
                            } 
                            else 
                            {
                              url = domain+'/api/user/token.json';
                              payload = {api_key: client._metadata.settings.wiz_api_key, email: agentEmail}
                            }
                          }
                        }
                      });

                    }
                  });
                  
                 
                 
                }
              });

});

    });         
    


    
  </script>
    <div class="modal-content">
    <span class="close">&times;</span>
    <p id="textile_preview"></p>
  </div>
  <button id='link'>Preview Textile</button>
  <h3 id="greeting"></h3>
  <pre id="context"></pre>
  
</body>
</html>
